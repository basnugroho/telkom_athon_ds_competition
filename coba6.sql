WITH CombinedData AS (
    -- The UNION of your two datasets
    (
        SELECT
            tdca.reco_id_curr,
            tdca.contract_type_name,
            tdca.gender,
            tdca.own_car_flag,
            tdca.own_realty_flag,
            tdca.children_count,
            tdca.income,
            tdca.loan_body,
            tdca.annuity_payment,
            tdca.goods_price,
            tdca.type_suite_name,
            tdca.income_type_name,
            tdca.education_type_name,
            tdca.family_status_name,
            tdca.housing_type_name,
            tdca.population_relative_region,
            tdca.days_birth,
            tdca.days_employed,
            tdca.registration_timestamp,
            tdca.publication_timestamp,
            tdca.age_own_car,
            tdca.mobile_flag,
            tdca.employee_phone_flag,
            tdca.work_phone_flag,
            tdca.mobile_contact_flag,
            tdca.phone_flag,
            tdca.email_flag,
            tdca.type_of_occupation,
            tdca.family_members__count,
            tdca.rating_client_region,
            tdca.rating_client_w_city_region,
            tdca.start_weekday_appr_process,
            tdca.hour_of_approval_process_start,
            tdca.not_live_region_reg_region,
            tdca.not_work_region_reg_region,
            tdca.living_region_not_work_region_flag,
            tdca.not_live_city_reg_city,
            tdca.not_work_city_reg_city,
            tdca.living_city_not_work_city_flag,
            tdca.type_of_organization,
            tdca.external_source_1,
            tdca.external_source_2,
            tdca.external_source_3,
            tdca.average_apartments,
            tdca.average_basementarea,
            tdca.average_years_beginexpluatation,
            tdca.average_years_building,
            tdca.average_commonarea,
            tdca.average_elevator_count,
            tdca.average_entrance_count,
            tdca.average_max_floors,
            tdca.average_min_floors,
            tdca.average_land_area,
            tdca.average_living_apartments,
            tdca.average_living_area,
            tdca.non_living_apartments_av,
            tdca.non_living_area_avg,
            tdca.mode_apartments,
            tdca.mode_basementarea,
            tdca.mode_years_beginexpluatation,
            tdca.mode_years_building,
            tdca.mode_commonarea,
            tdca.mode_elevator_count,
            tdca.mode_entrance_count,
            tdca.mode_max_floors,
            tdca.mode_min_floors,
            tdca.mode_land_area,
            tdca.mode_living_apartments,
            tdca.mode_living_area,
            tdca.non_living_apartments_mode,
            tdca.non_living_area_mode,
            tdca.median_apartments,
            tdca.median_basementarea,
            tdca.median_years_beginexpluatation,
            tdca.median_years_building,
            tdca.median_commonarea,
            tdca.median_elevator_count,
            tdca.median_entrance_count,
            tdca.median_max_floors,
            tdca.median_min_floors,
            tdca.median_land_area,
            tdca.median_living_apartments,
            tdca.median_living_area,
            tdca.non_living_apartments_medi,
            tdca.non_living_area_medi,
            tdca.fondkapremon_mode,
            tdca.mode_house_type,
            tdca.mode_total_area,
            tdca.mode_walls_material,
            tdca.emergency_state_mode,
            tdca.observes_30_count_social_circle,
            tdca.social_circle_defaults_30_days,
            tdca.observes_60_count_social_circle,
            tdca.social_circle_defaults_60_days,
            tdca.last_phone_number_change,
            tdca.document_2_flag,
            tdca.document_3_flag,
            tdca.document_4_flag,
            tdca.document_5_flag,
            tdca.document_6_flag,
            tdca.document_7_flag,
            tdca.document_8_flag,
            tdca.document_9_flag,
            tdca.document_10_flag,
            tdca.document_11_flag,
            tdca.document_12_flag,
            tdca.document_13_flag,
            tdca.document_14_flag,
            tdca.document_15_flag,
            tdca.document_16_flag,
            tdca.document_17_flag,
            tdca.document_18_flag,
            tdca.document_19_flag,
            tdca.document_20_flag,
            tdca.document_21_flag,
            tdca.requests_bki_hour,
            tdca.requests_bki_day,
            tdca.requests_bki_week,
            tdca.requests_bki_month,
            tdca.requests_bki_qrt,
            tdca.requests_bki_year,
            -- ... Include other columns from TA4_DATASET_CREDIT_APPLICATION as required
            tdt.target
        FROM TA4_DATASET_CREDIT_APPLICATION tdca
        RIGHT JOIN TA4_DATASET_TARGET tdt ON tdca.reco_id_curr = tdt.reco_id_curr
        WHERE tdt.target = 1
        LIMIT 500
    )
    UNION ALL
    (
        SELECT
            tdca.reco_id_curr,
            tdca.contract_type_name,
            tdca.gender,
            tdca.own_car_flag,
            tdca.own_realty_flag,
            tdca.children_count,
            tdca.income,
            tdca.loan_body,
            tdca.annuity_payment,
            tdca.goods_price,
            tdca.type_suite_name,
            tdca.income_type_name,
            tdca.education_type_name,
            tdca.family_status_name,
            tdca.housing_type_name,
            tdca.population_relative_region,
            tdca.days_birth,
            tdca.days_employed,
            tdca.registration_timestamp,
            tdca.publication_timestamp,
            tdca.age_own_car,
            tdca.mobile_flag,
            tdca.employee_phone_flag,
            tdca.work_phone_flag,
            tdca.mobile_contact_flag,
            tdca.phone_flag,
            tdca.email_flag,
            tdca.type_of_occupation,
            tdca.family_members__count,
            tdca.rating_client_region,
            tdca.rating_client_w_city_region,
            tdca.start_weekday_appr_process,
            tdca.hour_of_approval_process_start,
            tdca.not_live_region_reg_region,
            tdca.not_work_region_reg_region,
            tdca.living_region_not_work_region_flag,
            tdca.not_live_city_reg_city,
            tdca.not_work_city_reg_city,
            tdca.living_city_not_work_city_flag,
            tdca.type_of_organization,
            tdca.external_source_1,
            tdca.external_source_2,
            tdca.external_source_3,
            tdca.average_apartments,
            tdca.average_basementarea,
            tdca.average_years_beginexpluatation,
            tdca.average_years_building,
            tdca.average_commonarea,
            tdca.average_elevator_count,
            tdca.average_entrance_count,
            tdca.average_max_floors,
            tdca.average_min_floors,
            tdca.average_land_area,
            tdca.average_living_apartments,
            tdca.average_living_area,
            tdca.non_living_apartments_av,
            tdca.non_living_area_avg,
            tdca.mode_apartments,
            tdca.mode_basementarea,
            tdca.mode_years_beginexpluatation,
            tdca.mode_years_building,
            tdca.mode_commonarea,
            tdca.mode_elevator_count,
            tdca.mode_entrance_count,
            tdca.mode_max_floors,
            tdca.mode_min_floors,
            tdca.mode_land_area,
            tdca.mode_living_apartments,
            tdca.mode_living_area,
            tdca.non_living_apartments_mode,
            tdca.non_living_area_mode,
            tdca.median_apartments,
            tdca.median_basementarea,
            tdca.median_years_beginexpluatation,
            tdca.median_years_building,
            tdca.median_commonarea,
            tdca.median_elevator_count,
            tdca.median_entrance_count,
            tdca.median_max_floors,
            tdca.median_min_floors,
            tdca.median_land_area,
            tdca.median_living_apartments,
            tdca.median_living_area,
            tdca.non_living_apartments_medi,
            tdca.non_living_area_medi,
            tdca.fondkapremon_mode,
            tdca.mode_house_type,
            tdca.mode_total_area,
            tdca.mode_walls_material,
            tdca.emergency_state_mode,
            tdca.observes_30_count_social_circle,
            tdca.social_circle_defaults_30_days,
            tdca.observes_60_count_social_circle,
            tdca.social_circle_defaults_60_days,
            tdca.last_phone_number_change,
            tdca.document_2_flag,
            tdca.document_3_flag,
            tdca.document_4_flag,
            tdca.document_5_flag,
            tdca.document_6_flag,
            tdca.document_7_flag,
            tdca.document_8_flag,
            tdca.document_9_flag,
            tdca.document_10_flag,
            tdca.document_11_flag,
            tdca.document_12_flag,
            tdca.document_13_flag,
            tdca.document_14_flag,
            tdca.document_15_flag,
            tdca.document_16_flag,
            tdca.document_17_flag,
            tdca.document_18_flag,
            tdca.document_19_flag,
            tdca.document_20_flag,
            tdca.document_21_flag,
            tdca.requests_bki_hour,
            tdca.requests_bki_day,
            tdca.requests_bki_week,
            tdca.requests_bki_month,
            tdca.requests_bki_qrt,
            tdca.requests_bki_year,
            -- ... Include other columns from TA4_DATASET_CREDIT_APPLICATION as required
            tdt.target
        FROM TA4_DATASET_CREDIT_APPLICATION tdca
        RIGHT JOIN TA4_DATASET_TARGET tdt ON tdca.reco_id_curr = tdt.reco_id_curr
        WHERE tdt.target = 0
        LIMIT 500
    )
)

SELECT
    c.reco_id_curr,
    c.contract_type_name,
    c.gender,
    c.own_car_flag,
    c.own_realty_flag,
    c.children_count,
    c.income,
    c.loan_body,
    c.goods_price,
    c.type_suite_name,
    c.income_type_name,
    c.education_type_name,
    c.family_status_name,
    c.housing_type_name,
    c.population_relative_region,
    c.days_birth,
    c.days_employed,
    c.registration_timestamp,
    c.publication_timestamp,
    c.age_own_car,
    c.mobile_flag,
    c.employee_phone_flag,
    c.work_phone_flag,
    c.mobile_contact_flag,
    c.phone_flag,
    c.email_flag,
    c.type_of_occupation,
    c.family_members__count,
    c.rating_client_region,
    c.rating_client_w_city_region,
    c.start_weekday_appr_process,
    c.hour_of_approval_process_start,
    c.not_live_region_reg_region,
    c.not_work_region_reg_region,
    c.living_region_not_work_region_flag,
    c.not_live_city_reg_city,
    c.not_work_city_reg_city,
    c.living_city_not_work_city_flag,
    c.type_of_organization,
    c.external_source_1,
    c.external_source_2,
    c.external_source_3,
    c.average_apartments,
    c.average_basementarea,
    c.average_years_beginexpluatation,
    c.average_years_building,
    c.average_commonarea,
    c.average_elevator_count,
    c.average_entrance_count,
    c.average_max_floors,
    c.average_min_floors,
    c.average_land_area,
    c.average_living_apartments,
    c.average_living_area,
    c.non_living_apartments_av,
    c.non_living_area_avg,
    c.mode_apartments,
    c.mode_basementarea,
    c.mode_years_beginexpluatation,
    c.mode_years_building,
    c.mode_commonarea,
    c.mode_elevator_count,
    c.mode_entrance_count,
    c.mode_max_floors,
    c.mode_min_floors,
    c.mode_land_area,
    c.mode_living_apartments,
    c.mode_living_area,
    c.non_living_apartments_mode,
    c.non_living_area_mode,
    c.median_apartments,
    c.median_basementarea,
    c.median_years_beginexpluatation,
    c.median_years_building,
    c.median_commonarea,
    c.median_elevator_count,
    c.median_entrance_count,
    c.median_max_floors,
    c.median_min_floors,
    c.median_land_area,
    c.median_living_apartments,
    c.median_living_area,
    c.non_living_apartments_medi,
    c.non_living_area_medi,
    c.fondkapremon_mode,
    c.mode_house_type,
    c.mode_total_area,
    c.mode_walls_material,
    c.emergency_state_mode,
    c.observes_30_count_social_circle,
    c.social_circle_defaults_30_days,
    c.observes_60_count_social_circle,
    c.social_circle_defaults_60_days,
    c.last_phone_number_change,
    c.document_2_flag,
    c.document_3_flag,
    c.document_4_flag,
    c.document_5_flag,
    c.document_6_flag,
    c.document_7_flag,
    c.document_8_flag,
    c.document_9_flag,
    c.document_10_flag,
    c.document_11_flag,
    c.document_12_flag,
    c.document_13_flag,
    c.document_14_flag,
    c.document_15_flag,
    c.document_16_flag,
    c.document_17_flag,
    c.document_18_flag,
    c.document_19_flag,
    c.document_20_flag,
    c.document_21_flag,
    c.requests_bki_hour,
    c.requests_bki_day,
    c.requests_bki_week,
    c.requests_bki_month,
    c.requests_bki_qrt,
    c.requests_bki_year,

    b.reco_bureau_id,
    b.credit_status,
    b.credit_currency,
    b.days_credit,
    b.avg_credit_day_overdue,
    b.days_credit_enddate,
    b.days_enddate_fact,
    b.credit_limit_max_overdue,
    b.credit_prolong_count,
    b.credit_sum,
    b.credit_sum_debt,
    b.credit_sum_limit,
    b.credit_sum_overdue,
    b.credit_type,
    b.max_days_credit_update,
    b.annuity_payment,

    -- bki_balance.months_balance,
    -- bki_balance.stat_for_bureau,

    -- dpl.max_loan_body_requested,
    -- dpl.loan_body,
    -- dpl.goods_price,
    -- dpl.contract_status_name,
    -- dpl.reject_reason_code,
    -- dpl.yield_group_name,
    c.target
FROM CombinedData c
LEFT JOIN (
    SELECT
        reco_id_curr,
        reco_bureau_id,
        credit_status,
        credit_currency,
        days_credit,
        AVG(credit_day_overdue) AS avg_credit_day_overdue,
        days_credit_enddate,
        days_enddate_fact,
        credit_limit_max_overdue,
        credit_prolong_count,
        credit_sum,
        credit_sum_debt,
        credit_sum_limit,
        credit_sum_overdue,
        credit_type,
        MAX(days_credit_update) AS max_days_credit_update,
        annuity_payment
    FROM TA4_DATASET_BKI
    GROUP BY reco_id_curr
) b ON c.reco_id_curr = b.reco_id_curr
-- LEFT JOIN TA4_DATASET_BKI_BALANCE bki_balance ON b.reco_bureau_id = bki_balance.reco_bureau_id AND bki_balance.months_balance = -1
-- LEFT JOIN (
--     SELECT dpl.reco_id_curr,
--            MAX(loan_body_requested) AS max_loan_body_requested,
--            loan_body,
--            goods_price,
--            contract_status_name,
--            reject_reason_code,
--            yield_group_name
--     FROM TA4_DATASET_PREVIOUS_LOAN dpl
--     GROUP BY dpl.reco_id_curr
-- ) dpl ON c.reco_id_curr = dpl.reco_id_curr